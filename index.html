<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Patrick Stanke Theater Abenteuer</title>
<style>
  body {
    margin: 0; background: #111;
    overflow: hidden;
    touch-action: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
  }
  canvas {
    background: linear-gradient(to top, #222 0%, #555 100%);
    display: block;
    margin: 0 auto;
    border: 3px solid #444;
    border-radius: 10px;
    max-width: 100vw;
    height: 80vh;
  }
  #hud {
    color: white;
    text-align: center;
    margin: 5px;
    font-size: 1.2em;
  }
  #message {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    color: #f2f2f2;
    background: rgba(0,0,0,0.8);
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 1.4em;
    display: none;
    z-index: 10;
  }
</style>
</head>
<body>

<div id="hud">Level: 1 | Leben: 5 | Noten: 0 / 5</div>
<div id="message"></div>
<canvas id="game" width="480" height="320"></canvas>

<script>
// Setup Canvas und Kontext
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const hud = document.getElementById('hud');
const message = document.getElementById('message');

// Steuerung
let keys = {};
window.addEventListener('keydown', e => { keys[e.key] = true; e.preventDefault(); });
window.addEventListener('keyup', e => { keys[e.key] = false; e.preventDefault(); });

// Handy-Touch Steuerung (links/rechts + springen)
let touchLeft = false;
let touchRight = false;
let touchJump = false;
canvas.addEventListener('touchstart', e => {
  for (let t of e.touches) {
    if (t.clientX < canvas.width / 3) touchLeft = true;
    else if (t.clientX > canvas.width * 2 / 3) touchRight = true;
    else touchJump = true;
  }
  e.preventDefault();
});
canvas.addEventListener('touchend', e => {
  if (e.touches.length === 0) {
    touchLeft = false;
    touchRight = false;
    touchJump = false;
  }
  e.preventDefault();
});

// Spielfigur (Patrick Stanke cartoonhaft)
class Player {
  constructor() {
    this.x = 50;
    this.y = 0;
    this.width = 28;
    this.height = 48;
    this.color = '#0088cc';
    this.velX = 0;
    this.velY = 0;
    this.speed = 2.5;
    this.jumping = false;
    this.lives = 5;
    this.notenGesammelt = 0;
  }

  draw() {
    // Cartoonhafte Figur inspiriert von Patrick Stanke
    ctx.save();
    ctx.translate(this.x + this.width/2, this.y + this.height/2);

    // Körper
    ctx.fillStyle = '#004466';
    ctx.fillRect(-14, -24, 28, 48);

    // Kopf (rund mit Haaren)
    ctx.beginPath();
    ctx.fillStyle = '#f7d7b9';
    ctx.arc(0, -30, 14, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Haare (scheitel nach rechts)
    ctx.beginPath();
    ctx.strokeStyle = '#552200';
    ctx.lineWidth = 3;
    ctx.moveTo(-10, -38);
    ctx.quadraticCurveTo(0, -52, 10, -38);
    ctx.stroke();

    // Augen
    ctx.fillStyle = '#222';
    ctx.beginPath();
    ctx.arc(-5, -30, 3, 0, Math.PI * 2);
    ctx.arc(5, -30, 3, 0, Math.PI * 2);
    ctx.fill();

    // Mund
    ctx.beginPath();
    ctx.strokeStyle = '#a22';
    ctx.lineWidth = 1.5;
    ctx.moveTo(-5, -20);
    ctx.quadraticCurveTo(0, -15, 5, -20);
    ctx.stroke();

    // Arme (lockerer Anzug)
    ctx.strokeStyle = '#003355';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(-14, -10);
    ctx.lineTo(-28, 10);
    ctx.moveTo(14, -10);
    ctx.lineTo(28, 10);
    ctx.stroke();

    // Beine
    ctx.strokeStyle = '#003355';
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(-10, 24);
    ctx.lineTo(-10, 48);
    ctx.moveTo(10, 24);
    ctx.lineTo(10, 48);
    ctx.stroke();

    ctx.restore();
  }

  update(platforms) {
    // Bewegung
    let friction = 0.8;
    let gravity = 0.6;

    // Links/Rechts Bewegung
    if (keys['ArrowLeft'] || touchLeft) {
      if (this.velX > -this.speed) this.velX -= 0.3;
    }
    if (keys['ArrowRight'] || touchRight) {
      if (this.velX < this.speed) this.velX += 0.3;
    }

    // Springen
    if ((keys['ArrowUp'] || touchJump) && !this.jumping) {
      this.velY = -11;
      this.jumping = true;
    }

    // Geschwindigkeit anwenden
    this.velX *= friction;
    this.velY += gravity;

    this.x += this.velX;
    this.y += this.velY;

    // Kollision mit Plattformen
    let grounded = false;
    for (let p of platforms) {
      if (this.x + this.width > p.x && this.x < p.x + p.width) {
        if (this.y + this.height > p.y && this.y + this.height < p.y + p.height) {
          grounded = true;
          this.jumping = false;
          this.velY = 0;
          this.y = p.y - this.height;
        }
      }
    }

    // Bildschirmbegrenzung
    if (this.x < 0) this.x = 0;
    if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
    if (this.y > canvas.height) {
      this.lives--;
      if (this.lives <= 0) {
        showMessage('Du hast keine Leben mehr. Spiel vorbei!');
        resetGame();
      } else {
        // Respawn am Anfang der Levelplattform
        this.x = 50;
        this.y = 0;
        this.velX = 0;
        this.velY = 0;
      }
    }
  }
}

// Plattformen (Bühnenboden, Treppen etc)
class Platform {
  constructor(x,y,width,height) {
    this.x = x;
    this.y = y;
    this.width = width;
    this.height = height;
  }

  draw() {
    ctx.fillStyle = '#663300'; // Holzbühne braun
    ctx.fillRect(this.x, this.y, this.width, this.height);
  }
}

// Sammelobjekt Notenblatt
class Note {
  constructor(x,y) {
    this.x = x;
    this.y = y;
    this.width = 24;
    this.height = 24;
    this.collected = false;
  }

  draw() {
    if (this.collected) return;
    // Notenblatt: weißes Blatt mit schwarzer Note
    ctx.fillStyle = '#fff';
    ctx.fillRect(this.x, this.y, this.width, this.height);
    ctx.fillStyle = '#000';
    ctx.font = '18px Arial';
    ctx.fillText('♩', this.x+6, this.y+18);
  }
}

// Gegner (Tomaten & Kritiker)
class Enemy {
  constructor(x,y,type) {
    this.x = x;
    this.y = y;
    this.width = 30;
    this.height = 30;
    this.type = type; // 'tomate' oder 'kritiker'
    this.speed = 1 + Math.random(); // zufällige Geschwindigkeit
    this.direction = 1;
  }

  draw() {
    if (this.type === 'tomate') {
      // einfache rote Tomate
      ctx.fillStyle = '#c00';
      ctx.beginPath();
      ctx.ellipse(this.x+15, this.y+15, 15, 15, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#060';
      ctx.fillRect(this.x+10, this.y+5, 10, 3);
    } else {
      // Kritiker mit Brille (eckig)
      ctx.fillStyle = '#555';
      ctx.fillRect(this.x, this.y, this.width, this.height);
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.strokeRect(this.x+5, this.y+8, 8, 8);
      ctx.strokeRect(this.x+17, this.y+8, 8, 8);
      ctx.beginPath();
      ctx.moveTo(this.x+5, this.y+22);
      ctx.lineTo(this.x+25, this.y+22);
      ctx.stroke();
    }
  }

  update(platforms) {
    // Gegner bewegt sich horizontal auf seiner Plattform
    this.x += this.speed * this.direction;

    // Begrenzung auf Plattform
    let onPlatform = false;
    for (let p of platforms) {
      if (this.x >= p.x && this.x + this.width <= p.x + p.width) {
        if (this.y + this.height === p.y + p.height) onPlatform = true;
      }
    }
    if (!onPlatform) this.direction *= -1;

    // Kollision mit Rand des Canvas
    if (this.x < 0) this.direction = 1;
    if (this.x + this.width > canvas.width) this.direction = -1;
  }
}

// Level Klasse
class Level {
  constructor(data) {
    this.platforms = data.platforms.map(p => new Platform(...p));
    this.notes = data.notes.map(n => new Note(...n));
    this.enemies = data.enemies.map(e => new Enemy(...e));
    this.notesNeeded = this.notes.length;
  }

  draw() {
    this.platforms.forEach(p => p.draw());
    this.notes.forEach(n => n.draw());
    this.enemies.forEach(e => e.draw());
  }

  update() {
    this.enemies.forEach(e => e.update(this.platforms));
  }
}

// Spiel Manager
class Game {
  constructor(levels) {
    this.levelsData = levels;
    this.currentLevelIndex = 0;
    this.player = new Player();
    this.level = new Level(this.levelsData[this.currentLevelIndex]);
  }

  update() {
    this.player.update(this.level.platforms);
    this.level.update();

    // Check Noten einsammeln
    this.level.notes.forEach(note => {
      if (!note.collected && collideRect(this.player, note)) {
        note.collected = true;
        this.player.notenGesammelt++;
      }
    });

    // Check Gegner Kollision
    this.level.enemies.forEach(enemy => {
      if (collideRect(this.player, enemy)) {
        this.player.lives--;
        this.player.x = 50;
        this.player.y = 0;
        this.player.velX = 0;
        this.player.velY = 0;
        if (this.player.lives <= 0) {
          showMessage('Du hast keine Leben mehr. Spiel vorbei!');
          resetGame();
        }
      }
    });

    // Check ob alle Noten eingesammelt
    if (this.player.notenGesammelt >= this.level.notesNeeded) {
      this.nextLevel();
    }

    updateHud(this.currentLevelIndex + 1, this.player.lives, this.player.notenGesammelt, this.level.notesNeeded);
  }

  nextLevel() {
    this.currentLevelIndex++;
    if (this.currentLevelIndex >= this.levelsData.length) {
      showMessage('Glückwunsch! Du hast alle Level geschafft!');
      this.currentLevelIndex = 0;
    }
    this.player.x = 50;
    this.player.y = 0;
    this.player.velX = 0;
    this.player.velY = 0;
    this.player.notenGesammelt = 0;
    this.level = new Level(this.levelsData[this.currentLevelIndex]);
  }

  draw() {
    this.level.draw();
    this.player.draw();
  }
}

// Hilfsfunktionen
function collideRect(a, b) {
  return a.x < b.x + b.width &&
         a.x + a.width > b.x &&
         a.y < b.y + b.height &&
         a.y + a.height > b.y;
}

function updateHud(level, lives, collected, needed) {
  hud.textContent = `Level: ${level} | Leben: ${lives} | Noten: ${collected} / ${needed}`;
}

function showMessage(text) {
  message.textContent = text;
  message.style.display = 'block';
  setTimeout(() => message.style.display = 'none', 4000);
}

function resetGame() {
  game.player.lives = 5;
  game.player.notenGesammelt = 0;
  game.currentLevelIndex = 0;
  game.level = new Level(levelsData[0]);
  game.player.x = 50;
  game.player.y = 0;
  game.player.velX = 0;
  game.player.velY = 0;
}

// Beispiel Level-Daten (5 Levels, einfach erweiterbar)
const levelsData = [
  {
    platforms: [
      [0, 280, 480, 40],       // Boden
      [100, 230, 120, 15],     // Podest 1
      [280, 180, 150, 15],     // Podest 2
    ],
    notes: [
      [120, 190], [300, 140], [350, 140], [150, 190], [320, 140],
    ],
    enemies: [
      [130, 265, 'tomate'],
      [300, 165, 'kritiker'],
    ]
  },
  {
    platforms: [
      [0, 280, 480, 40],
      [50, 240, 80, 15],
      [180, 200, 100, 15],
      [320, 150, 120, 15],
    ],
    notes: [
      [70, 200], [200, 160], [340, 110], [350, 110], [360, 110],
    ],
    enemies: [
      [60, 225, 'kritiker'],
      [340, 135, 'tomate'],
      [180, 185, 'tomate'],
    ]
  },
  {
    platforms: [
      [0, 280, 480, 40],
      [60, 240, 90, 15],
      [180, 210, 90, 15],
      [310, 160, 120, 15],
      [150, 270, 70, 10],
    ],
    notes: [
      [70, 200], [200, 170], [330, 120], [160, 230], [170, 230],
    ],
    enemies: [
      [200, 195, 'kritiker'],
      [320, 145, 'tomate'],
      [160, 260, 'tomate'],
      [100, 225, 'kritiker'],
    ]
  },
  {
    platforms: [
      [0, 280, 480, 40],
      [100, 230, 100, 15],
      [230, 180, 150, 15],
      [400, 130, 70, 15],
      [50, 260, 70, 10],
    ],
    notes: [
      [110, 190], [240, 140], [410, 90], [60, 220], [55, 220],
    ],
    enemies: [
      [110, 215, 'kritiker'],
      [240, 165, 'tomate'],
      [400, 115, 'tomate'],
      [60, 245, 'kritiker'],
    ]
  },
  {
    platforms: [
      [0, 280, 480, 40],
      [50, 240, 80, 15],
      [150, 200, 70, 15],
      [250, 160, 120, 15],
      [390, 120, 80, 15],
    ],
    notes: [
      [70, 200], [160, 160], [270, 120], [400, 80], [410, 80],
    ],
    enemies: [
      [70, 225, 'tomate'],
      [160, 185, 'kritiker'],
      [250, 145, 'tomate'],
      [400, 105, 'kritiker'],
    ]
  },
];

// Spiel starten
let
