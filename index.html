<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Theaterheld – Patrick Stanke Musical Game</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    background: #111;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
  }
  #game {
    display: block;
    margin: 0 auto;
    background: linear-gradient(to top, #330000, #440000);
    border: 4px solid #990000;
    image-rendering: optimizeSpeed;
    max-width: 100vw;
    max-height: 100vh;
    touch-action: none;
  }
  #hud {
    position: fixed;
    top: 12px; left: 12px;
    color: #ffdddd;
    font-weight: 700;
    font-size: 20px;
    text-shadow: 0 0 6px #bb4444;
    z-index: 10;
  }
  #controls {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    display: flex;
    justify-content: space-around;
    z-index: 10;
  }
  .btn {
    width: 70px; height: 70px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 34px;
    color: white;
    user-select: none;
    touch-action: manipulation;
    box-shadow: 0 0 12px #990000;
  }
  .btn:active {
    background: rgba(255, 255, 255, 0.4);
  }
</style>
</head>
<body>

<div id="hud">Level: 1 | Punkte: 0 | Leben: 3</div>
<div id="controls">
  <div class="btn" id="leftBtn">&#8592;</div>
  <div class="btn" id="jumpBtn">&#8593;</div>
  <div class="btn" id="rightBtn">&#8594;</div>
</div>

<canvas id="game" width="480" height="320"></canvas>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;

  // --- Hilfsfunktionen ---

  function rectsCollide(a, b) {
    return a.x < b.x + b.width &&
           a.x + a.width > b.x &&
           a.y < b.y + b.height &&
           a.y + a.height > b.y;
  }
  function circleRectCollide(circle, rect) {
    const distX = Math.abs(circle.x - rect.x - rect.width/2);
    const distY = Math.abs(circle.y - rect.y - rect.height/2);
    if (distX > (rect.width/2 + circle.radius)) return false;
    if (distY > (rect.height/2 + circle.radius)) return false;
    if (distX <= (rect.width/2)) return true;
    if (distY <= (rect.height/2)) return true;
    const dx = distX - rect.width/2;
    const dy = distY - rect.height/2;
    return (dx*dx + dy*dy <= (circle.radius*circle.radius));
  }

  // --- Klassen ---

  class Player {
    constructor() {
      this.width = 32;
      this.height = 48;
      this.reset();
      this.speed = 2.8;
      this.jumpPower = 8;
      this.gravity = 0.4;
      this.facing = 1; // 1 rechts, -1 links
      this.frame = 0;
      this.frameTimer = 0;
    }
    reset() {
      this.x = 40;
      this.y = HEIGHT - 70;
      this.vx = 0;
      this.vy = 0;
      this.onGround = false;
      this.lives = 3;
      this.score = 0;
    }
    update(platforms) {
      this.x += this.vx;

      // Bildschirmbegrenzung horizontal
      if (this.x < 0) this.x = 0;
      if (this.x + this.width > WIDTH) this.x = WIDTH - this.width;

      // Gravitation & vertikale Bewegung
      this.vy += this.gravity;
      this.y += this.vy;

      this.onGround = false;
      for (const p of platforms) {
        if (
          this.x < p.x + p.width &&
          this.x + this.width > p.x &&
          this.y + this.height > p.y &&
          this.y + this.height < p.y + p.height &&
          this.vy >= 0
        ) {
          this.y = p.y - this.height;
          this.vy = 0;
          this.onGround = true;
        }
      }

      // Boden unten (wenn runterfällt)
      if (this.y + this.height > HEIGHT) {
        this.lives--;
        this.respawn();
      }

      // Animation (läuft)
      if (this.vx !== 0 && this.onGround) {
        this.frameTimer++;
        if (this.frameTimer > 6) {
          this.frame = (this.frame + 1) % 4;
          this.frameTimer = 0;
        }
      } else {
        this.frame = 0;
        this.frameTimer = 0;
      }
    }
    respawn() {
      this.x = 40;
      this.y = HEIGHT - 70;
      this.vx = 0;
      this.vy = 0;
    }
    draw(ctx) {
      ctx.save();
      ctx.translate(this.x + this.width/2, this.y + this.height/2);
      ctx.scale(this.facing, 1);

      // Kopf (Haut)
      ctx.fillStyle = '#e6c07b';
      ctx.beginPath();
      ctx.ellipse(0, -15, 12, 16, 0, 0, Math.PI * 2);
      ctx.fill();

      // Haare
      ctx.fillStyle = '#4a2c1a';
      ctx.beginPath();
      ctx.ellipse(0, -27, 14, 8, 0, 0, Math.PI * 2);
      ctx.fill();

      // Frisur fransig vorne
      ctx.beginPath();
      ctx.moveTo(-10, -23);
      ctx.lineTo(-7, -16);
      ctx.lineTo(-4, -23);
      ctx.lineTo(-1, -16);
      ctx.lineTo(2, -23);
      ctx.lineTo(5, -16);
      ctx.lineTo(8, -23);
      ctx.closePath();
      ctx.fill();

      // Gesicht: Augen
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(-5, -18, 2, 0, Math.PI * 2);
      ctx.arc(5, -18, 2, 0, Math.PI * 2);
      ctx.fill();

      // Körper: schwarzer Anzug
      ctx.fillStyle = '#222';
      ctx.fillRect(-12, 0, 24, 38);

      // Weißes Hemd
      ctx.fillStyle = '#fff';
      ctx.fillRect(-10, 10, 20, 18);

      // Hosen & Schuhe
      ctx.fillStyle = '#222';
      ctx.fillRect(-12, 38, 24, 18);
      ctx.fillStyle = '#333';
      ctx.fillRect(-12, 56, 24, 8);

      ctx.restore();
    }
  }

  class Platform {
    constructor(x, y, width, height) {
      this.x = x;
      this.y = y;
      this.width = width;
      this.height = height;
    }
    draw(ctx) {
      // Bühne Holzoptik
      const baseColor = '#6b4226';
      const lineColor = '#a97449';
      ctx.fillStyle = baseColor;
      ctx.fillRect(this.x, this.y, this.width, this.height);

      // Holzstreifen
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = 2;
      for (let i = 0; i < this.width; i += 12) {
        ctx.beginPath();
        ctx.moveTo(this.x + i, this.y);
        ctx.lineTo(this.x + i, this.y + this.height);
        ctx.stroke();
      }
    }
  }

  class Note {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.radius = 12;
      this.collected = false;
    }
    draw(ctx) {
      if (this.collected) return;

      // Notenblatt: weiße ovale mit schwarzer Note
      ctx.save();
      ctx.translate(this.x, this.y);

      // Blatt
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.ellipse(0, 0, 12, 18, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Notenschlüssel stilisiert
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      ctx.moveTo(0, -10);
      ctx.bezierCurveTo(10, -10, 10, 10, 0, 10);
      ctx.bezierCurveTo(-8, 10, -8, -5, 0, -5);
      ctx.stroke();

      ctx.restore();
    }
  }

  class Enemy {
    constructor(x, y, range) {
      this.x = x;
      this.y = y;
      this.width = 28;
      this.height = 38;
      this.speed = 1.3;
      this.dir = 1;
      this.range = range;
      this.originX = x;
      this.alive = true;
    }
    update() {
      if (!this.alive) return;
      this.x += this.speed * this.dir;
      if (this.x > this.originX + this.range) this.dir = -1;
      if (this.x < this.originX) this.dir = 1;
    }
    draw(ctx) {
      if (!this.alive) return;
      // Einfacher roter Bühnengeist / Monster
      ctx.fillStyle = '#bb2222';
      ctx.fillRect(this.x, this.y, this.width, this.height);

      // Augen
